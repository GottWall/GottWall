{% macro render_metric(metric) -%}
{%- set filter_name = metric["filter_name"] -%}
{%- set filter_value = metric["filter_value"] -%}
{"name": "{{ metric["name"]|e }}{% if filter_name and filter_value %} | {{ filter_name|e }}:{{ filter_value|e }}{% endif %}",
 "color": palette.color(),
 "data": [{% for item in metric["range"] -%}{"x": {{ x_converter(item[0]) }}, "y": {{ item[1]|e }}}{% if not loop.last %},{% endif %}{%- endfor %}]
}
{% endmacro %}

{% macro renderer_item(r) %}
<input type="radio" value="{{ r }}" id="{{ r }}" name="renderer" {% if data['renderer']|e == r %}checked{% endif %}> &mdash;
<label for="{{ r }}">{{ r }}</label><br>
{% endmacro %}

<!DOCTYPE html>
<html>
  <head>
    <title>{{ handler.settings["site_title"] }} → {{ data["name"]|e }}</title>
    <meta name="description" content="{{ handler.settings["site_title"] }} → {{ data["name"]|e }}"/>
    <meta name="title" content="{{ handler.settings["site_title"] }}" />
    <meta name="generator" content="{{ generator }}" />

    <link rel="stylesheet" type="text/css" media="all" href="{{ static }}css/rickshaw.min.css"/>
    <link rel="stylesheet" type="text/css" media="all" href="{{ static }}css/graph.css"/>
    <script type="text/javascript" src="{{ static }}js/jquery.js"></script>
    <script type="text/javascript" src="{{ static }}js/d3.v2.js"></script>
    <script type="text/javascript" src="{{ static }}vendor/rickshaw.js"></script>
    <style type="text/css" media="screen">
      {% include "embedded.css" %}
    </style>
  </head>
  <body>
    <content>
      <div id="chart-container">
	<h2 style="width: {{ width+40 }}px;">{{ data["name"]|e }}</h2>
	<h3 style="width: {{ width+40 }}px;">{{ data["from_date"]|e }} &mdash; {{ data["to_date"]|e }}</h3>
        <div id="y_axis" style="height: {{height}}px"></div>
        <div id="graph" style="height:{{ height }}px; width: {{ width }}px;"></div>
	<div id="sidebar">
	  <div id="legend"></div>
	  <div id="renderers">
	    <form id="renderers_form" class="toggler">
	      <ul>
		<li>{{ renderer_item("line") }}</li>
		<li>{{ renderer_item("stack") }}</li>
		<li>{{ renderer_item("area") }}</li>
		<li>{{ renderer_item("bar") }}</li>
		<li>{{ renderer_item("scatterplot") }}</li>
            </form>
	  </div>
	</div>
	<div id="x_axis" style="width: {{ width }}px;"></div>
      </div>
    </content>
    {% block footer %}
    <footer>
      <div class="generator">{% trans generator=data["generator"], site_name=handler.settings["site_title"] -%}
	Generated by <a href="{{ gottwall_home }}" title="{{ gottwall_description }}">{{ generator }}</a> for {{ site_name }}{%- endtrans -%}
      </div>
    </footer>
    {% endblock %}

    <script type="text/javascript">
    var date_display_formatters = {
      "day": d3.time.format("%Y-%m-%d, %A"),
      "year": d3.time.format("%Y"),
      "month": d3.time.format("%Y-%m, %B"),
      "hour": d3.time.format("%Y-%m-%dT%H"),
      "minute": d3.time.format("%Y-%m-%dT%H:%M"),
      "week": d3.time.format("%Y-%W")
    }

    var date_formatter = date_display_formatters["{{ data["period"]|e }}"];
    console.log(date_formatter);

    var timestamp_to_date = function(timestamp){
      return new Date(timestamp * 1000);
    }

    var pretty_date_format = function(d){
      try {
	return date_formatter(timestamp_to_date(d));
      }
      catch (e){
	return "";
      }

    }
      var palette = new Rickshaw.Color.Palette();

      var graph = new Rickshaw.Graph( {
      padding: {
	top: 0.25,
	bottom: 0.5
      },
      height: {{ height }},
      width: {{ width }},
      renderer: "{{ data['renderer']|e }}",
      //{% if interpolation %}interpolation: "{{ interpolation|e }}",{% endif %}
      element: document.querySelector("#graph"),
      series: [{% for metric in data["metrics"] -%}{{ render_metric(metric) -}}{%- if not loop.last -%},{%- endif -%}{%- endfor %}]
    });

      var legend = new Rickshaw.Graph.Legend({
      graph: graph,
      element: document.querySelector("#legend")
      });



    var x_axis = new Rickshaw.Graph.Axis.X({
      height: 20,
      graph: graph,
      orientation: "top",
      //pixelsPerTick: 100,
      //element: document.getElementById("x_axis"),
      tickFormat: pretty_date_format,
    });

    var y_axis = new Rickshaw.Graph.Axis.Y({
      graph: graph,
      orientation: "left",
      element: document.getElementById("y_axis"),
      tickFormat: Rickshaw.Fixtures.Number.formatKMBT,
    });

    var shelving = new Rickshaw.Graph.Behavior.Series.Toggle( {
	graph: graph,
	legend: legend
} );

      var highlighter = new Rickshaw.Graph.Behavior.Series.Highlight({
          graph: graph,
          legend: legend
      });


    var hoverDetail = new Rickshaw.Graph.HoverDetail({
    	graph: graph,
	formatter: function(series, x, y) {
	  var date = "<span class=\"date\">" + pretty_date_format(x) + "</span>";
		var swatch = "<span class=\"detail_swatch\" style=\"background-color: " + series.color + "\"></span>";
		var content = swatch + series.name + " → " + parseInt(y) + "<br>" + date;
		return content;
	}
    });

    var renderer_form = document.getElementById("renderers_form");

    renderer_form.addEventListener("change", function(e) {
        graph.setRenderer(e.target.value);

        graph.render();

}, false);
      graph.render();
    </script>
</body>
</html>
